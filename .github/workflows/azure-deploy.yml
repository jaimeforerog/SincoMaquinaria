name: Deploy to Azure

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write
  checks: write
  statuses: write

env:
  AZURE_WEBAPP_NAME: 'sincomaquinaria-app-1601'
  AZURE_RESOURCE_GROUP: 'SincoMaquinariaRG'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # Login to Azure
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # Get ACR credentials
    - name: Get ACR Info
      id: acr
      run: |
        # Find ACR in the resource group
        ACR_NAME=$(az acr list --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query "[0].name" -o tsv)
        ACR_LOGIN_SERVER=$(az acr show --name $ACR_NAME --query "loginServer" -o tsv)
        ACR_USERNAME=$(az acr credential show --name $ACR_NAME --query "username" -o tsv)
        ACR_PASSWORD=$(az acr credential show --name $ACR_NAME --query "passwords[0].value" -o tsv)
        echo "ACR_NAME=$ACR_NAME" >> $GITHUB_OUTPUT
        echo "ACR_LOGIN_SERVER=$ACR_LOGIN_SERVER" >> $GITHUB_OUTPUT
        echo "ACR_USERNAME=$ACR_USERNAME" >> $GITHUB_OUTPUT
        echo "ACR_PASSWORD=$ACR_PASSWORD" >> $GITHUB_OUTPUT

    # Login to ACR with Docker
    - name: Login to Azure Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ steps.acr.outputs.ACR_LOGIN_SERVER }}
        username: ${{ steps.acr.outputs.ACR_USERNAME }}
        password: ${{ steps.acr.outputs.ACR_PASSWORD }}

    # Set up Docker Buildx
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # Build and push Docker image
    - name: Build and Push Docker Image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          ${{ steps.acr.outputs.ACR_LOGIN_SERVER }}/sincomaquinaria:${{ github.sha }}
          ${{ steps.acr.outputs.ACR_LOGIN_SERVER }}/sincomaquinaria:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    # Update Web App to use new image
    - name: Update Web App Container
      run: |
        az webapp config container set \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --container-image-name ${{ steps.acr.outputs.ACR_LOGIN_SERVER }}/sincomaquinaria:${{ github.sha }}

    # Restart the Web App
    - name: Restart Web App
      run: |
        az webapp restart \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }}

    - name: Azure Logout
      run: az logout
