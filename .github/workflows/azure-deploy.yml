name: Deploy to Azure

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: 'sincomaquinaria-app-1601'
  AZURE_RESOURCE_GROUP: 'SincoMaquinariaRG'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # Login to Azure
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # Get ACR credentials
    - name: Get ACR Info
      id: acr
      run: |
        # Find ACR in the resource group
        ACR_NAME=$(az acr list --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query "[0].name" -o tsv)
        ACR_LOGIN_SERVER=$(az acr show --name $ACR_NAME --query "loginServer" -o tsv)
        echo "ACR_NAME=$ACR_NAME" >> $GITHUB_OUTPUT
        echo "ACR_LOGIN_SERVER=$ACR_LOGIN_SERVER" >> $GITHUB_OUTPUT

    # Login to ACR
    - name: Login to Azure Container Registry
      run: |
        az acr login --name ${{ steps.acr.outputs.ACR_NAME }}

    # Build and push Docker image using ACR Tasks (faster, builds in cloud)
    - name: Build and Push Docker Image
      run: |
        az acr build \
          --registry ${{ steps.acr.outputs.ACR_NAME }} \
          --image sincomaquinaria:${{ github.sha }} \
          --image sincomaquinaria:latest \
          .

    # Update Web App to use new image
    - name: Update Web App Container
      run: |
        az webapp config container set \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --container-image-name ${{ steps.acr.outputs.ACR_LOGIN_SERVER }}/sincomaquinaria:${{ github.sha }}

    # Restart the Web App
    - name: Restart Web App
      run: |
        az webapp restart \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }}

    - name: Azure Logout
      run: az logout
