name: Deploy to Azure

on:
  push:
    branches:
      - main
      - production
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  id-token: write
  checks: write
  statuses: write
  pull-requests: write

env:
  AZURE_RESOURCE_GROUP: 'SincoMaquinariaRG'
  AZURE_WEBAPP_NAME: 'sincomaquinaria-app-1601'
  AZURE_ACR_NAME: 'sincomaquinariaacr1743'
  ENVIRONMENT: 'prod'
  BASE_NAME: 'sincomaquinaria'

jobs:
  # Job 1: Build and Test
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Restore dependencies
      run: dotnet restore src/SincoMaquinaria/SincoMaquinaria.csproj

    - name: Build
      run: dotnet build src/SincoMaquinaria/SincoMaquinaria.csproj --configuration Release --no-restore

    - name: Test
      run: dotnet test SincoMaquinaria.Tests/SincoMaquinaria.Tests.csproj --configuration Release --no-build --verbosity normal

  # Job 2: Build and Push Docker Image
  build-and-push:
    name: Build and Push Docker Image
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/production')
    continue-on-error: true

    outputs:
      acr-login-server: ${{ steps.acr.outputs.ACR_LOGIN_SERVER }}
      acr-username: ${{ steps.acr.outputs.ACR_USERNAME }}
      acr-password: ${{ steps.acr.outputs.ACR_PASSWORD }}
      container-app-name: ${{ steps.acr.outputs.CONTAINER_APP_NAME }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Check if Resource Group exists
      id: check-rg
      run: |
        if az group show --name ${{ env.AZURE_RESOURCE_GROUP }} &> /dev/null; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "⚠️ Resource Group ${{ env.AZURE_RESOURCE_GROUP }} no existe."
          echo "Por favor ejecuta: cd infrastructure/azure && ./deploy.sh"
          exit 1
        fi

    - name: Get ACR Info
      id: acr
      if: steps.check-rg.outputs.exists == 'true'
      run: |
        ACR_NAME=${{ env.AZURE_ACR_NAME }}
        ACR_LOGIN_SERVER=$(az acr show --name $ACR_NAME --query "loginServer" -o tsv)
        ACR_USERNAME=$(az acr credential show --name $ACR_NAME --query "username" -o tsv)
        ACR_PASSWORD=$(az acr credential show --name $ACR_NAME --query "passwords[0].value" -o tsv)

        echo "ACR_NAME=$ACR_NAME" >> $GITHUB_OUTPUT
        echo "ACR_LOGIN_SERVER=$ACR_LOGIN_SERVER" >> $GITHUB_OUTPUT
        echo "ACR_USERNAME=$ACR_USERNAME" >> $GITHUB_OUTPUT
        echo "ACR_PASSWORD=$ACR_PASSWORD" >> $GITHUB_OUTPUT

    - name: Login to Azure Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ steps.acr.outputs.ACR_LOGIN_SERVER }}
        username: ${{ steps.acr.outputs.ACR_USERNAME }}
        password: ${{ steps.acr.outputs.ACR_PASSWORD }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Extract version
      id: version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          VERSION=$(git rev-parse --short HEAD)
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"

    - name: Build and Push Docker Image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          ${{ steps.acr.outputs.ACR_LOGIN_SERVER }}/sincomaquinaria:${{ steps.version.outputs.VERSION }}
          ${{ steps.acr.outputs.ACR_LOGIN_SERVER }}/sincomaquinaria:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILDKIT_INLINE_CACHE=1

    - name: Azure Logout
      if: always()
      run: az logout

  # Job 3: Deploy to Azure Web App
  deploy:
    name: Deploy to Azure
    needs: build-and-push
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy to Azure Web App
      id: deploy
      run: |
        ACR_LOGIN_SERVER="${{ needs.build-and-push.outputs.acr-login-server }}"
        ACR_USERNAME="${{ needs.build-and-push.outputs.acr-username }}"
        ACR_PASSWORD="${{ needs.build-and-push.outputs.acr-password }}"

        echo "Deploying to Web App: ${{ env.AZURE_WEBAPP_NAME }}"

        # Configure ACR credentials
        az webapp config appsettings set \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --settings \
            DOCKER_REGISTRY_SERVER_URL=https://$ACR_LOGIN_SERVER \
            DOCKER_REGISTRY_SERVER_USERNAME=$ACR_USERNAME \
            DOCKER_REGISTRY_SERVER_PASSWORD=$ACR_PASSWORD

        # Update Web App to use the new container image
        az webapp config container set \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --docker-custom-image-name $ACR_LOGIN_SERVER/sincomaquinaria:latest \
          --docker-registry-server-url https://$ACR_LOGIN_SERVER

        # Restart the Web App to apply changes
        az webapp restart \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }}

        APP_URL="${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
        echo "app-url=$APP_URL" >> $GITHUB_OUTPUT
        echo "Deployed to: https://$APP_URL"

    - name: Health Check
      run: |
        APP_URL="${{ steps.deploy.outputs.app-url }}"
        echo "Running health check on https://$APP_URL/health"

        # Wait for deployment and app restart to complete
        sleep 60

        # Retry health check up to 5 times
        for i in {1..5}; do
          if curl -f -s "https://$APP_URL/health" > /dev/null; then
            echo "✓ Health check passed!"
            exit 0
          fi
          echo "Health check attempt $i failed, retrying in 10 seconds..."
          sleep 10
        done

        echo "✗ Health check failed after 5 attempts"
        exit 1

    - name: Azure Logout
      if: always()
      run: az logout

  # Job 4: Notify
  notify:
    name: Notify Deployment Status
    needs: deploy
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Send notification
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "✅ Deployment to production succeeded!"
        else
          echo "❌ Deployment to production failed!"
          exit 1
        fi
